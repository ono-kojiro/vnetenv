######################################################
はじめに
######################################################

本書ではFreeBSD 14.0およびbhyveを使用した仮想ネットワーク環境の
構築手順を説明する。

*******************************
ハードウェア
*******************************

PC: DELL Optiplex 7060 Micro
CPU: Intel Core i5-8500, 6CPUs
Memory: 16GB

*******************************
ソフトウェア
*******************************

ホストPC
===================================

OS: FreeBSD 14.0-RELEASE-p6, amd64
vm-bhyve 1.5.0

NAT用仮想マシン
===================================

OS: OPNsense 24.1

クライアント用仮想マシン
===================================

OS: NetBSD 10.0



*******************************
ネットワーク構成概要
*******************************

ネットワークセグメント
===================================

単一のホスト内に以下の４つの仮想ネットワークセグメントを作成する。

+-------------------------------+----------------------+----------------------+
| セグメント                    | ネットワーク         | 備考                 |
+===============================+======================+======================+
| 物理ネットワークセグメント0   | 192.168.0.0/24       | ホストが所属         |
+-------------------------------+----------------------+----------------------+
| 仮想ネットワークセグメント1   | 192.168.1.0/24       |                      |
+-------------------------------+----------------------+----------------------+
| 仮想ネットワークセグメント10  | 192.168.10.0/24      |                      |
+-------------------------------+----------------------+----------------------+
| 仮想ネットワークセグメント20  | 192.168.20.0/24      |                      |
+-------------------------------+----------------------+----------------------+
| 仮想ネットワークセグメント30  | 192.168.30.0/24      |                      |
+-------------------------------+----------------------+----------------------+

NAT(ホストと仮想ネットワークセグメント間)
==========================================================================

ホストの属するセグメント(192.168.0.0/24) と セグメント1(192.168.1.0/24) は
ホストのNAT機能を利用してセグメント1の端末が外部に接続できるようにする。

NAT(仮想ネットワーク間)
==========================================================================

仮想熱t−ワークセグメント間にはNAT機能を持つVMを接続し、
VMのNAT機能を用いて外部に接続できるようにする。


*******************************
ネットワーク構成図
*******************************

      <Host Area>          <Bridge Area>       <Switch Area>                     <VM Area>

+-------------------+     +-------------+     +-----------------+
| host              |     | bridge1     |     | vm-sw1          |
|           em0     | NAT |             |     | (no ip addr)    |
|   192.168.0.84/24 |-----| 192.168.1.1 |-----|                 |
|                   |     |             |     |                 |
+-------------------+     +-------------+     +-----------------+
                                                |
                                                +------------------------+
                                                                         |
                                                                       +--------------------------+
                                              +------------------+     | vnet1: 192.168.1.254/24  |
                                              | vm-sw10          |     |                          |
                                              | 192.168.10.84/24 |-----| opnsense10               |
                                              |                  |     |  gw: 192.168.1.1         |
                                              |                  |     |                          |
                                              |                  |     |  vnet0: 192.168.10.1/24  |
                                              +------------------+     +--------------------------+
                                                |
                                                +------------------------+
                                                                         |
                                                                       +--------------------------+
                                              +------------------+     | vnet1: 192.168.10.254/24 |
                                              | vm-sw20          |     |                          |
                                              | 192.168.20.84/24 |-----| opnsense20               |
                                              |                  |     |   gw: 192.168.10.1       |
                                              |                  |     |                          |
                                              |                  |     |  vnet0: 192.168.20.1/24  |
                                              +------------------+     +--------------------------+
                                                |
                                                +------------------------+
                                                                         |
                                                                       +--------------------------+
                                              +------------------+     | vnet1: 192.168.20.254/24 |
                                              | vm-sw30          |     |                          |
                                              | 192.168.30.84/24 |-----| opnsense30               |
                                              |                  |     |   gw: 192.168.20.1       |
                                              |                  |     |                          |
                                              |                  |     |  vnet0: 192.168.30.1/24  |
                                              +------------------+     +--------------------------+

                                                              
############################
準備
############################

**************************************
ホストOSのセットアップ
**************************************

今回は仮想ネットワークをFreeBSD上に構築する。

FreeBSDをセットアップするPCの固定IPアドレスを以下のように設定する。

192.168.0.98/24

また、ファイルシステムはZFSを使用する。


**************************************
インストール後の設定
**************************************

ipfw_load="YES"
ipdivert_load="YES"
net.inet.ip.fw.default_to_accept="1"


************************************************
参考文献
************************************************

FreeBSD Handbook, Chapter 31 Advanced Networking, 31.9 Network Address Translation
https://docs-archive.freebsd.org/doc/7.4-RELEASE/usr/share/doc/handbook/network-natd.html
